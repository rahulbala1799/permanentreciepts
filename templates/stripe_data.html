<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Stripe Data - Receipts Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">Receipts Automation</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('receipts_page') }}">Reconciliation Jobs</a>
                <a class="nav-link" href="#" onclick="goBackToSubsidiary()">Back to Subsidiary</a>
                <a class="nav-link active" href="#">Stripe Data</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-file-csv text-primary"></i> Stripe Transaction Data</h1>
                        <p class="lead" id="subsidiary-info">Loading...</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="goBackToSubsidiary()">
                            <i class="fas fa-arrow-left"></i> Back to Subsidiary
                        </button>
                        <button class="btn btn-warning" onclick="showUploadModal()">
                            <i class="fas fa-upload"></i> Upload New File
                        </button>
                        <button class="btn btn-success" onclick="startRecProcess()" id="start-rec-btn">
                            <i class="fas fa-play"></i> Start Rec Process
                        </button>
                        <button class="btn btn-danger" onclick="deleteStripeData()">
                            <i class="fas fa-trash"></i> Delete All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Transaction Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="total-transactions" class="text-primary">0</h4>
                                    <small class="text-muted">Total Transactions</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="total-amount" class="text-success">$0.00</h4>
                                    <small class="text-muted">Total Amount</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="total-fees" class="text-warning">$0.00</h4>
                                    <small class="text-muted">Total Fees</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="total-net" class="text-info">$0.00</h4>
                                    <small class="text-muted">Total Net</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-filter"></i> Filter Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="client-filter" class="form-label">Client Number</label>
                                <input type="text" class="form-control" id="client-filter" placeholder="Filter by client number">
                            </div>
                            <div class="col-md-3">
                                <label for="type-filter" class="form-label">Transaction Type</label>
                                <select class="form-select" id="type-filter">
                                    <option value="">All Types</option>
                                    <option value="Charge">Charge</option>
                                    <option value="Stripe Fee">Stripe Fee</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="amount-min" class="form-label">Min Amount</label>
                                <input type="number" class="form-control" id="amount-min" placeholder="0.00" step="0.01">
                            </div>
                            <div class="col-md-3">
                                <label for="amount-max" class="form-label">Max Amount</label>
                                <input type="number" class="form-control" id="amount-max" placeholder="1000.00" step="0.01">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-table"></i> Stripe Transactions</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportData()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Client #</th>
                                        <th>Type</th>
                                        <th>Created</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Fees</th>
                                        <th>Net</th>
                                        <th>Currency</th>
                                        <th>Customer</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-table-body">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Loading transactions...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Transaction pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload New Stripe CSV File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Select Stripe CSV File</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".csv">
                            <div class="form-text">This will replace all existing Stripe data for this subsidiary</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="uploadNewFile()">Upload New File</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const jobId = {{ job_id }};
        const subsidiaryId = {{ subsidiary_id }};
        let allTransactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSubsidiaryDetails();
            loadStripeTransactions();
        });

        function loadSubsidiaryDetails() {
            fetch('/api/subsidiaries')
                .then(response => response.json())
                .then(subsidiaries => {
                    const subsidiary = subsidiaries.find(s => s.id === subsidiaryId);
                    if (subsidiary) {
                        document.getElementById('subsidiary-info').textContent = `Stripe data for ${subsidiary.name}`;
                        document.getElementById('page-title').textContent = `Stripe Data - ${subsidiary.name}`;
                    }
                })
                .catch(error => {
                    console.error('Error loading subsidiary details:', error);
                });
        }

        function loadStripeTransactions() {
            fetch(`/api/stripe-transactions/${jobId}/${subsidiaryId}`)
                .then(response => response.json())
                .then(transactions => {
                    allTransactions = transactions;
                    filteredTransactions = [...transactions];
                    updateSummary();
                    displayTransactions();
                })
                .catch(error => {
                    console.error('Error loading Stripe transactions:', error);
                    const tbody = document.getElementById('transactions-table-body');
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error loading transactions</td></tr>';
                });
        }

        function updateSummary() {
            const totalTransactions = filteredTransactions.length;
            const totalAmount = filteredTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalFees = filteredTransactions.reduce((sum, t) => sum + (t.fees || 0), 0);
            const totalNet = filteredTransactions.reduce((sum, t) => sum + (t.net || 0), 0);
            
            document.getElementById('total-transactions').textContent = totalTransactions;
            document.getElementById('total-amount').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('total-fees').textContent = `$${totalFees.toFixed(2)}`;
            document.getElementById('total-net').textContent = `$${totalNet.toFixed(2)}`;
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactions-table-body');
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No transactions found</td></tr>';
                return;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageTransactions.map(transaction => `
                <tr>
                    <td>${transaction.client_number || '-'}</td>
                    <td><span class="badge ${transaction.type === 'Charge' ? 'bg-success' : 'bg-warning'}">${transaction.type || '-'}</span></td>
                    <td>${transaction.created || '-'}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${transaction.description || ''}">${transaction.description || '-'}</td>
                    <td>$${(transaction.amount || 0).toFixed(2)}</td>
                    <td>$${(transaction.fees || 0).toFixed(2)}</td>
                    <td>$${(transaction.net || 0).toFixed(2)}</td>
                    <td>${transaction.currency || '-'}</td>
                    <td class="text-truncate" style="max-width: 150px;" title="${transaction.customer_name || transaction.customer_email || ''}">${transaction.customer_name || transaction.customer_email || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTransaction(${transaction.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
            </li>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Next button
            paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
            </li>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayTransactions();
            }
        }

        function applyFilters() {
            const clientFilter = document.getElementById('client-filter').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const amountMin = parseFloat(document.getElementById('amount-min').value) || 0;
            const amountMax = parseFloat(document.getElementById('amount-max').value) || Infinity;
            
            filteredTransactions = allTransactions.filter(transaction => {
                const clientMatch = !clientFilter || (transaction.client_number && transaction.client_number.toLowerCase().includes(clientFilter));
                const typeMatch = !typeFilter || transaction.type === typeFilter;
                const amountMatch = (transaction.amount || 0) >= amountMin && (transaction.amount || 0) <= amountMax;
                
                return clientMatch && typeMatch && amountMatch;
            });
            
            currentPage = 1;
            updateSummary();
            displayTransactions();
        }

        function clearFilters() {
            document.getElementById('client-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('amount-min').value = '';
            document.getElementById('amount-max').value = '';
            
            filteredTransactions = [...allTransactions];
            currentPage = 1;
            updateSummary();
            displayTransactions();
        }

        function viewTransaction(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (transaction) {
                alert(`Transaction Details:\n\nClient: ${transaction.client_number}\nType: ${transaction.type}\nAmount: $${transaction.amount}\nDescription: ${transaction.description}\nCreated: ${transaction.created}`);
            }
        }

        function showUploadModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
        }

        function uploadNewFile() {
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const uploadBtn = document.querySelector('#uploadModal .btn-warning');
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'Uploading...';
            uploadBtn.disabled = true;
            
            fetch(`/api/stripe-upload/${jobId}/${subsidiaryId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    alert(`Successfully uploaded ${data.transactions_added} transactions!`);
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    loadStripeTransactions(); // Reload data
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Error uploading file');
            })
            .finally(() => {
                uploadBtn.textContent = originalText;
                uploadBtn.disabled = false;
                fileInput.value = '';
            });
        }

        function deleteStripeData() {
            if (confirm('Are you sure you want to delete all Stripe data for this subsidiary? This action cannot be undone.')) {
                fetch(`/api/stripe-transactions/${jobId}/${subsidiaryId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        alert(`Successfully deleted ${data.deleted_count} Stripe transactions!`);
                        loadStripeTransactions(); // Reload data
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    alert('Error deleting Stripe data');
                });
            }
        }

        function exportData() {
            // Convert filtered transactions to CSV
            const csvContent = [
                'Client Number,Type,ID,Created,Description,Amount,Currency,Fees,Net,Customer Name,Customer Email',
                ...filteredTransactions.map(t => 
                    `"${t.client_number || ''}","${t.type || ''}","${t.stripe_id || ''}","${t.created || ''}","${t.description || ''}",${t.amount || 0},"${t.currency || ''}",${t.fees || 0},${t.net || 0},"${t.customer_name || ''}","${t.customer_email || ''}"`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stripe_transactions_${subsidiaryId}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function goBackToSubsidiary() {
            window.location.href = `/reconciliation/${jobId}/${subsidiaryId}`;
        }

        function startRecProcess() {
            // Show loading state
            const button = document.getElementById('start-rec-btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating Fees...';
            button.disabled = true;
            
            // Call the reconciliation API to calculate fees
            fetch(`/api/start-reconciliation/${jobId}/${subsidiaryId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    button.innerHTML = originalText;
                    button.disabled = false;
                    return;
                }
                
                // Display fee calculation results at the top
                displayFeeResults(data.fees_calculation);
                
                // Reset button
                button.innerHTML = originalText;
                button.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error starting reconciliation: ${error.message}`);
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        function displayFeeResults(fees) {
            // Create fee display section at the top of the page
            const feeSection = document.createElement('div');
            feeSection.id = 'fee-results-section';
            feeSection.className = 'alert alert-info mb-4';
            feeSection.innerHTML = `
                <div class="row">
                    <div class="col-md-12">
                        <h5><i class="fas fa-calculator"></i> Fee Calculation Results</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Column I Fees:</strong><br>
                                <span class="text-success">$${fees.column_i_fees.total}</span><br>
                                <small class="text-muted">${fees.column_i_fees.count} transactions</small>
                            </div>
                            <div class="col-md-3">
                                <strong>Network Cost:</strong><br>
                                <span class="text-success">$${fees.network_cost_fees.total}</span><br>
                                <small class="text-muted">${fees.network_cost_fees.count} transactions</small>
                            </div>
                            <div class="col-md-3">
                                <strong>Stripe Fee:</strong><br>
                                <span class="text-success">$${fees.stripe_fee_fees.total}</span><br>
                                <small class="text-muted">${fees.stripe_fee_fees.count} transactions</small>
                            </div>
                            <div class="col-md-3">
                                <strong>Total Fees:</strong><br>
                                <span class="text-primary h5">$${fees.total_all_fees}</span>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <button class="btn btn-success btn-lg" onclick="startProcess1()">
                                <i class="fas fa-play"></i> Start Process 1
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert at the top of the main content
            const mainContent = document.querySelector('.container');
            const existingFeeSection = document.getElementById('fee-results-section');
            if (existingFeeSection) {
                existingFeeSection.remove();
            }
            mainContent.insertBefore(feeSection, mainContent.firstChild);
        }

        function startProcess1() {
            alert(`Starting Process 1 for subsidiary ${subsidiaryId}. This will match Stripe transactions with Cashbook transactions based on client_id and amount.`);
            // TODO: Implement Process 1 logic
        }
    </script>
</body>
</html>
