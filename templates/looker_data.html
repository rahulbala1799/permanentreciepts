<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Looker Data - Receipts Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">Receipts Automation</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('receipts_page') }}">Reconciliation Jobs</a>
                <a class="nav-link" href="#" onclick="goBackToLooker()">Back to Looker</a>
                <a class="nav-link active" href="#">Looker Data</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-chart-line text-primary"></i> Looker Cashbook Data</h1>
                        <p class="lead" id="job-info">Viewing Looker data for <span id="job-name">Loading...</span></p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="goBackToLooker()">
                            <i class="fas fa-arrow-left"></i> Back to Looker
                        </button>
                        <button class="btn btn-warning" onclick="fixDataErrors()" id="fix-errors-btn" style="display: none;">
                            <i class="fas fa-wrench"></i> Fix Data Errors
                        </button>
                        <button class="btn btn-info" onclick="fixLocationCorrections()" id="fix-locations-btn" style="display: none;">
                            <i class="fas fa-map-marker-alt"></i> Fix Location Corrections
                        </button>
                        <button class="btn btn-success" onclick="fixBankAccounts()" id="fix-bank-accounts-btn" style="display: none;">
                            <i class="fas fa-university"></i> Fix Bank Accounts
                        </button>
                        <button class="btn btn-primary" onclick="downloadExcel()" id="download-excel-btn">
                            <i class="fas fa-file-excel"></i> Download Excel
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showUploadModal()">
                            <i class="fas fa-upload"></i> Upload New File
                        </button>
                        <button class="btn btn-danger" onclick="deleteLookerData()">
                            <i class="fas fa-trash"></i> Delete All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Data Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="total-transactions" class="text-primary">0</h4>
                                    <small class="text-muted">Total Transactions</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="total-amount" class="text-success">$0.00</h4>
                                    <small class="text-muted">Total Amount</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="unique-clients" class="text-info">0</h4>
                                    <small class="text-muted">Unique Clients</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="date-range" class="text-warning">-</h4>
                                    <small class="text-muted">Date Range</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-filter"></i> Filter Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="client-filter" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="client-filter" placeholder="Filter by client ID">
                            </div>
                            <div class="col-md-3">
                                <label for="billing-entity-filter" class="form-label">Billing Entity</label>
                                <select class="form-select" id="billing-entity-filter">
                                    <option value="">All Entities</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="transtype-filter" class="form-label">Transaction Type</label>
                                <select class="form-select" id="transtype-filter">
                                    <option value="">All Types</option>
                                    <option value="CARDSUCCESS">CARDSUCCESS</option>
                                    <option value="MANUAL">MANUAL</option>
                                    <option value="SEPA">SEPA</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="amount-min" class="form-label">Min Amount</label>
                                <input type="number" class="form-control" id="amount-min" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-table"></i> Looker Cashbook Transactions</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportData()">
                                <i class="fas fa-download"></i> Export Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Index</th>
                                        <th>Payment Date</th>
                                        <th>Client ID</th>
                                        <th>Invoice Number</th>
                                        <th>Billing Entity</th>
                                        <th>AR Account</th>
                                        <th>Currency</th>
                                        <th>Exchange Rate</th>
                                        <th>Amount</th>
                                        <th>Account</th>
                                        <th>Location</th>
                                        <th>Type</th>
                                        <th>Comment</th>
                                        <th>Reason Code</th>
                                        <th>SEPA Provider</th>
                                        <th>Stripe Charge ID</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-table-body">
                                    <tr>
                                        <td colspan="17" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Loading transactions...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Transaction pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload New Looker Cashbook File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Select Looker Excel File</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls">
                            <div class="form-text">This will replace all existing Looker data for this job</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="uploadNewFile()">Upload New File</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const jobId = {{ job_id }};
        let allTransactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadJobDetails();
            loadLookerTransactions();
        });

        function loadJobDetails() {
            fetch(`/api/jobs/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('job-name').textContent = data.job_name;
                    document.getElementById('job-info').textContent = `Viewing Looker data for ${data.job_name}`;
                    document.getElementById('page-title').textContent = `Looker Data - ${data.job_name}`;
                })
                .catch(error => {
                    console.error('Error loading job details:', error);
                });
        }

        function loadLookerTransactions() {
            fetch(`/api/looker-cashbook-transactions/${jobId}`)
                .then(response => response.json())
                .then(transactions => {
                    allTransactions = transactions;
                    filteredTransactions = [...transactions];
                    populateFilterOptions();
                    updateSummary();
                    displayTransactions();
                })
                .catch(error => {
                    console.error('Error loading Looker transactions:', error);
                    const tbody = document.getElementById('transactions-table-body');
                    tbody.innerHTML = '<tr><td colspan="17" class="text-center text-danger">Error loading transactions</td></tr>';
                });
        }

        function populateFilterOptions() {
            // Populate billing entity filter
            const billingEntityFilter = document.getElementById('billing-entity-filter');
            const uniqueBillingEntities = [...new Set(allTransactions.map(t => t.billing_entity).filter(Boolean))];
            
            // Clear existing options except "All Entities"
            billingEntityFilter.innerHTML = '<option value="">All Entities</option>';
            
            // Add unique billing entities
            uniqueBillingEntities.sort().forEach(entity => {
                const option = document.createElement('option');
                option.value = entity;
                option.textContent = entity;
                billingEntityFilter.appendChild(option);
            });
            
            // Check for data errors and show fix button
            const dataErrors = allTransactions.filter(t => t.billing_entity === 'DATA ERROR');
            const fixBtn = document.getElementById('fix-errors-btn');
            
            if (dataErrors.length > 0) {
                fixBtn.style.display = 'inline-block';
                fixBtn.innerHTML = `<i class="fas fa-wrench"></i> Fix Data Errors (${dataErrors.length})`;
            } else {
                fixBtn.style.display = 'none';
            }
            
            // Check for location corrections needed and show fix button
            const locationCorrections = allTransactions.filter(t => 
                (t.location === 'Germany' || t.location === 'Switzerland' || t.location === 'Austria') &&
                t.billing_entity === 'Ndevor Systems Ltd : Phorest Ireland'
            );
            const irelandBankCorrections = allTransactions.filter(t => 
                t.billing_entity === 'Ndevor Systems Ltd : Phorest Ireland' &&
                t.account === '10010 Bank : BOI current a/c € # 17013705'
            );
            const fixLocationsBtn = document.getElementById('fix-locations-btn');
            
            if (locationCorrections.length > 0 || irelandBankCorrections.length > 0) {
                fixLocationsBtn.style.display = 'inline-block';
                const totalCorrections = locationCorrections.length + irelandBankCorrections.length;
                fixLocationsBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i> Fix Location Corrections (${totalCorrections})`;
            } else {
                fixLocationsBtn.style.display = 'none';
            }
            
            // Check for bank account corrections needed and show fix button
            const bankAccountCorrections = allTransactions.filter(t => {
                const correctAccounts = {
                    'Ndevor Systems Ltd : Phorest Australia': '10130 Bank : CB current a/c AU$ # 411110236694',
                    'Ndevor Systems Ltd : Phorest Canada': '10150 Bank : CIBC Current Account 9066314',
                    'Ndevor Systems Ltd : Phorest US': '10043 Bank : CIBC operating a/c US$ # 2605090',
                    'Ndevor Systems Ltd : Phorest Ireland : Phorest UK': '10020 Bank : BOI current a/c GBP # 62100285',
                    'Ndevor Systems Ltd : Phorest Ireland': '10010 Bank : BOI current a/c EUR # 17013705',
                    'Ndevor Systems Ltd : Phorest Germany': '10010c Bank : Dummy Interco Bank Accounts : Interco - BOI current a/c Ä # 17013705 (Germany)'
                };
                return t.billing_entity in correctAccounts && t.account !== correctAccounts[t.billing_entity];
            });
            const fixBankAccountsBtn = document.getElementById('fix-bank-accounts-btn');
            
            if (bankAccountCorrections.length > 0) {
                fixBankAccountsBtn.style.display = 'inline-block';
                fixBankAccountsBtn.innerHTML = `<i class="fas fa-university"></i> Fix Bank Accounts (${bankAccountCorrections.length})`;
            } else {
                fixBankAccountsBtn.style.display = 'none';
            }
        }

        function updateSummary() {
            const totalTransactions = filteredTransactions.length;
            const totalAmount = filteredTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            const uniqueClients = new Set(filteredTransactions.map(t => t.client_id).filter(id => id)).size;
            
            // Calculate date range
            const dates = filteredTransactions.map(t => t.payment_date).filter(d => d);
            let dateRange = '-';
            if (dates.length > 0) {
                const sortedDates = dates.sort();
                const startDate = new Date(sortedDates[0]).toLocaleDateString();
                const endDate = new Date(sortedDates[sortedDates.length - 1]).toLocaleDateString();
                dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;
            }
            
            document.getElementById('total-transactions').textContent = totalTransactions;
            document.getElementById('total-amount').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('unique-clients').textContent = uniqueClients;
            document.getElementById('date-range').textContent = dateRange;
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactions-table-body');
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="17" class="text-center text-muted">No transactions found</td></tr>';
                return;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageTransactions.map(transaction => `
                <tr>
                    <td>${transaction.unnamed_index || '-'}</td>
                    <td>${transaction.payment_date ? new Date(transaction.payment_date).toLocaleDateString() : '-'}</td>
                    <td><span class="badge bg-primary">${transaction.client_id || '-'}</span></td>
                    <td class="text-truncate" style="max-width: 150px;" title="${transaction.invoice_number || ''}">${transaction.invoice_number || '-'}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${transaction.billing_entity || ''}">${transaction.billing_entity || '-'}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${transaction.ar_account || ''}">${transaction.ar_account || '-'}</td>
                    <td>${transaction.currency || '-'}</td>
                    <td>${transaction.exchange_rate || '-'}</td>
                    <td>$${(transaction.amount || 0).toFixed(2)}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${transaction.account || ''}">${transaction.account || '-'}</td>
                    <td>${transaction.location || '-'}</td>
                    <td><span class="badge ${transaction.transtype === 'CARDSUCCESS' ? 'bg-success' : 'bg-info'}">${transaction.transtype || '-'}</span></td>
                    <td class="text-truncate" style="max-width: 200px;" title="${transaction.comment || ''}">${transaction.comment || '-'}</td>
                    <td>${transaction.reasoncode || '-'}</td>
                    <td>${transaction.sepa_provider || '-'}</td>
                    <td class="text-truncate" style="max-width: 150px;" title="${transaction.stripe_charge_id || ''}">${transaction.stripe_charge_id || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTransaction(${transaction.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
            </li>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Next button
            paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
            </li>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayTransactions();
            }
        }

        function applyFilters() {
            const clientFilter = document.getElementById('client-filter').value.toLowerCase();
            const billingEntityFilter = document.getElementById('billing-entity-filter').value;
            const transtypeFilter = document.getElementById('transtype-filter').value;
            const amountMin = parseFloat(document.getElementById('amount-min').value) || 0;
            
            filteredTransactions = allTransactions.filter(transaction => {
                const clientMatch = !clientFilter || (transaction.client_id && transaction.client_id.toString().includes(clientFilter));
                const billingEntityMatch = !billingEntityFilter || transaction.billing_entity === billingEntityFilter;
                const transtypeMatch = !transtypeFilter || transaction.transtype === transtypeFilter;
                const amountMatch = (transaction.amount || 0) >= amountMin;
                
                return clientMatch && billingEntityMatch && transtypeMatch && amountMatch;
            });
            
            currentPage = 1;
            updateSummary();
            displayTransactions();
        }

        function clearFilters() {
            document.getElementById('client-filter').value = '';
            document.getElementById('billing-entity-filter').value = '';
            document.getElementById('transtype-filter').value = '';
            document.getElementById('amount-min').value = '';
            
            filteredTransactions = [...allTransactions];
            currentPage = 1;
            updateSummary();
            displayTransactions();
        }

        function viewTransaction(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (transaction) {
                alert(`Transaction Details:\n\nClient ID: ${transaction.client_id}\nInvoice: ${transaction.invoice_number}\nAmount: $${transaction.amount}\nType: ${transaction.transtype}\nDate: ${transaction.payment_date}\nComment: ${transaction.comment}`);
            }
        }

        function showUploadModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
        }

        function uploadNewFile() {
            console.log('Starting upload process...');
            console.log('Job ID:', jobId);
            
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an Excel file to upload');
                return;
            }
            
            console.log('Selected file:', file.name, 'Size:', file.size);
            
            const formData = new FormData();
            formData.append('file', file);
            
            const uploadBtn = document.querySelector('#uploadModal .btn-primary');
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'Uploading...';
            uploadBtn.disabled = true;
            
            console.log('Sending request to:', `/api/looker-cashbook-upload/${jobId}`);
            
            fetch(`/api/looker-cashbook-upload/${jobId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    alert(`Successfully uploaded ${data.transactions_added} transactions!`);
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    loadLookerTransactions(); // Reload data
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert(`Error uploading file: ${error.message}`);
            })
            .finally(() => {
                uploadBtn.textContent = originalText;
                uploadBtn.disabled = false;
                fileInput.value = '';
            });
        }

        function deleteLookerData() {
            if (confirm('Are you sure you want to delete all Looker Cashbook data for this job? This action cannot be undone.')) {
                fetch(`/api/looker-cashbook-transactions/${jobId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        alert(`Successfully deleted ${data.deleted_count} Looker Cashbook transactions!`);
                        loadLookerTransactions(); // Reload data
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    alert('Error deleting Looker Cashbook data');
                });
            }
        }

        function exportData() {
            // Convert filtered transactions to CSV
            const csvContent = [
                'Index,Payment Date,Client ID,Invoice Number,Billing Entity,AR Account,Currency,Exchange Rate,Amount,Account,Location,Type,Comment,Reason Code,SEPA Provider,Stripe Charge ID',
                ...filteredTransactions.map(t => 
                    `"${t.unnamed_index || ''}","${t.payment_date || ''}","${t.client_id || ''}","${t.invoice_number || ''}","${t.billing_entity || ''}","${t.ar_account || ''}","${t.currency || ''}",${t.exchange_rate || 0},${t.amount || 0},"${t.account || ''}","${t.location || ''}","${t.transtype || ''}","${t.comment || ''}",${t.reasoncode || 0},"${t.sepa_provider || ''}","${t.stripe_charge_id || ''}"`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `looker_cashbook_${jobId}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function goBackToLooker() {
            window.location.href = `/prepare/looker-cashbook/${jobId}`;
        }

        function fixDataErrors() {
            if (confirm('This will fix all DATA ERROR entries in the billing entity field:\n\n• CAD currency → Ndevor Systems Ltd : Phorest Canada\n• AED currency → Ndevor Systems Ltd : Phorest Ireland\n\nContinue?')) {
                // Show loading state
                const fixBtn = document.getElementById('fix-errors-btn');
                const originalText = fixBtn.innerHTML;
                fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
                fixBtn.disabled = true;
                
                fetch(`/api/looker-cashbook-fix-errors/${jobId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        let message = `✅ Data errors fixed successfully!\n\n`;
                        message += `• Total errors fixed: ${data.errors_fixed}\n`;
                        message += `• CAD transactions fixed: ${data.cad_fixed}\n`;
                        message += `• AED transactions fixed: ${data.aed_fixed}\n`;
                        message += `• Errors remaining: ${data.errors_remaining}\n`;
                        message += `• Total transactions: ${data.total_transactions}`;
                        
                        alert(message);
                        
                        // Reload data to show updated filters
                        loadLookerTransactions();
                    }
                })
                .catch(error => {
                    console.error('Fix errors error:', error);
                    alert('Error fixing data errors');
                })
                .finally(() => {
                    fixBtn.innerHTML = originalText;
                    fixBtn.disabled = false;
                });
            }
        }

        function fixLocationCorrections() {
            if (confirm('This will apply location-based corrections:\n\n• Germany/Switzerland/Austria locations with "Phorest Ireland" → "Phorest Germany" with German bank account\n• Remaining "Phorest Ireland" transactions → correct EUR bank account format\n\nContinue?')) {
                // Show loading state
                const fixBtn = document.getElementById('fix-locations-btn');
                const originalText = fixBtn.innerHTML;
                fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
                fixBtn.disabled = true;
                
                fetch(`/api/looker-cashbook-fix-locations/${jobId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        let message = `✅ Location corrections applied successfully!\n\n`;
                        message += `• Location corrections (Germany/Switzerland/Austria): ${data.location_corrections}\n`;
                        message += `• Ireland bank account corrections: ${data.ireland_bank_corrections}\n`;
                        message += `• Total corrections: ${data.location_corrections + data.ireland_bank_corrections}\n`;
                        message += `• Total transactions: ${data.total_transactions}`;
                        
                        alert(message);
                        
                        // Reload data to show updated filters
                        loadLookerTransactions();
                    }
                })
                .catch(error => {
                    console.error('Fix location corrections error:', error);
                    alert('Error fixing location corrections');
                })
                .finally(() => {
                    fixBtn.innerHTML = originalText;
                    fixBtn.disabled = false;
                });
            }
        }

        function fixBankAccounts() {
            if (confirm('This will fix all bank accounts based on billing entities:\n\n• Australia → CB current a/c AU$\n• Canada → CIBC Current Account\n• US → CIBC operating a/c US$\n• UK → BOI current a/c GBP\n• Ireland → BOI current a/c EUR\n• Germany → Interco - BOI current a/c Ä (Germany)\n\nContinue?')) {
                // Show loading state
                const fixBtn = document.getElementById('fix-bank-accounts-btn');
                const originalText = fixBtn.innerHTML;
                fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
                fixBtn.disabled = true;
                
                fetch(`/api/looker-cashbook-fix-bank-accounts/${jobId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        let message = `✅ Bank account corrections applied successfully!\n\n`;
                        message += `• Total corrections: ${data.total_corrections}\n`;
                        message += `• Total transactions: ${data.total_transactions}\n\n`;
                        message += 'Corrections made:\n';
                        for (const [correction, count] of Object.entries(data.corrections)) {
                            message += `• ${count} transactions: ${correction}\n`;
                        }
                        
                        alert(message);
                        
                        // Reload data to show updated filters
                        loadLookerTransactions();
                    }
                })
                .catch(error => {
                    console.error('Fix bank accounts error:', error);
                    alert('Error fixing bank accounts');
                })
                .finally(() => {
                    fixBtn.innerHTML = originalText;
                    fixBtn.disabled = false;
                });
            }
        }

        function downloadExcel() {
            // Show loading state
            const downloadBtn = document.getElementById('download-excel-btn');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
            downloadBtn.disabled = true;
            
            // Create download link
            const link = document.createElement('a');
            link.href = `/api/looker-cashbook-download/${jobId}`;
            link.download = `looker_cashbook_corrected_job_${jobId}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Reset button
            setTimeout(() => {
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }, 2000);
        }
    </script>
</body>
</html>
