<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Cashbook Data - Receipts Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">Receipts Automation</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('receipts_page') }}">Reconciliation Jobs</a>
                <a class="nav-link" href="#" onclick="goBackToSubsidiary()">Back to Subsidiary</a>
                <a class="nav-link active" href="#">Cashbook Data</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-file-excel text-primary"></i> Cashbook Transaction Data</h1>
                        <p class="lead" id="subsidiary-info">Loading...</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="goBackToSubsidiary()">
                            <i class="fas fa-arrow-left"></i> Back to Subsidiary
                        </button>
                        <button class="btn btn-secondary" onclick="showUploadModal()">
                            <i class="fas fa-upload"></i> Upload New File
                        </button>
                        <button class="btn btn-danger" onclick="deleteCashbookData()">
                            <i class="fas fa-trash"></i> Delete All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Transaction Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="total-transactions" class="text-primary">0</h4>
                                    <small class="text-muted">Total Transactions</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="total-amount" class="text-success">$0.00</h4>
                                    <small class="text-muted">Total Amount</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="unique-clients" class="text-info">0</h4>
                                    <small class="text-muted">Unique Clients</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="date-range" class="text-warning">-</h4>
                                    <small class="text-muted">Date Range</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-filter"></i> Filter Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="client-filter" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="client-filter" placeholder="Filter by client ID">
                            </div>
                            <div class="col-md-3">
                                <label for="type-filter" class="form-label">Transaction Type</label>
                                <select class="form-select" id="type-filter">
                                    <option value="">All Types</option>
                                    <option value="CARDSUCCESS">CARDSUCCESS</option>
                                    <option value="SEPA">SEPA</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="amount-min" class="form-label">Min Amount</label>
                                <input type="number" class="form-control" id="amount-min" placeholder="0.00" step="0.01">
                            </div>
                            <div class="col-md-3">
                                <label for="amount-max" class="form-label">Max Amount</label>
                                <input type="number" class="form-control" id="amount-max" placeholder="1000.00" step="0.01">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-table"></i> Cashbook Transactions</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportData()">
                                <i class="fas fa-download"></i> Export Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Payment Date</th>
                                        <th>Client ID</th>
                                        <th>Invoice #</th>
                                        <th>Billing Entity</th>
                                        <th>Amount</th>
                                        <th>Currency</th>
                                        <th>Type</th>
                                        <th>Location</th>
                                        <th>Comment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-table-body">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Loading transactions...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Transaction pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload New Cashbook Excel File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Select Cashbook Excel File</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls">
                            <div class="form-text">This will replace all existing Cashbook data for this subsidiary</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-secondary" onclick="uploadNewFile()">Upload New File</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const jobId = {{ job_id }};
        const subsidiaryId = {{ subsidiary_id }};
        let allTransactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSubsidiaryDetails();
            loadCashbookTransactions();
        });

        function loadSubsidiaryDetails() {
            fetch('/api/subsidiaries')
                .then(response => response.json())
                .then(subsidiaries => {
                    const subsidiary = subsidiaries.find(s => s.id === subsidiaryId);
                    if (subsidiary) {
                        document.getElementById('subsidiary-info').textContent = `Cashbook data for ${subsidiary.name}`;
                        document.getElementById('page-title').textContent = `Cashbook Data - ${subsidiary.name}`;
                    }
                })
                .catch(error => {
                    console.error('Error loading subsidiary details:', error);
                });
        }

        function loadCashbookTransactions() {
            fetch(`/api/cashbook-transactions/${jobId}/${subsidiaryId}`)
                .then(response => response.json())
                .then(transactions => {
                    allTransactions = transactions;
                    filteredTransactions = [...transactions];
                    updateSummary();
                    displayTransactions();
                })
                .catch(error => {
                    console.error('Error loading Cashbook transactions:', error);
                    const tbody = document.getElementById('transactions-table-body');
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error loading transactions</td></tr>';
                });
        }

        function updateSummary() {
            const totalTransactions = filteredTransactions.length;
            const totalAmount = filteredTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            const uniqueClients = new Set(filteredTransactions.map(t => t.client_id).filter(id => id)).size;
            
            // Calculate date range
            const dates = filteredTransactions.map(t => t.payment_date).filter(d => d);
            let dateRange = '-';
            if (dates.length > 0) {
                const sortedDates = dates.sort();
                dateRange = sortedDates[0] === sortedDates[sortedDates.length - 1] ? 
                    sortedDates[0] : `${sortedDates[0]} - ${sortedDates[sortedDates.length - 1]}`;
            }
            
            document.getElementById('total-transactions').textContent = totalTransactions;
            document.getElementById('total-amount').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('unique-clients').textContent = uniqueClients;
            document.getElementById('date-range').textContent = dateRange;
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactions-table-body');
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No transactions found</td></tr>';
                return;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageTransactions.map(transaction => `
                <tr>
                    <td>${transaction.payment_date || '-'}</td>
                    <td><span class="badge bg-primary">${transaction.client_id || '-'}</span></td>
                    <td class="text-truncate" style="max-width: 150px;" title="${transaction.invoice_number || ''}">${transaction.invoice_number || '-'}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${transaction.billing_entity || ''}">${transaction.billing_entity || '-'}</td>
                    <td>$${(transaction.amount || 0).toFixed(2)}</td>
                    <td>${transaction.currency || '-'}</td>
                    <td><span class="badge ${transaction.transtype === 'CARDSUCCESS' ? 'bg-success' : 'bg-info'}">${transaction.transtype || '-'}</span></td>
                    <td>${transaction.location || '-'}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${transaction.comment || ''}">${transaction.comment || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTransaction(${transaction.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
            </li>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Next button
            paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
            </li>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayTransactions();
            }
        }

        function applyFilters() {
            const clientFilter = document.getElementById('client-filter').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const amountMin = parseFloat(document.getElementById('amount-min').value) || 0;
            const amountMax = parseFloat(document.getElementById('amount-max').value) || Infinity;
            
            filteredTransactions = allTransactions.filter(transaction => {
                const clientMatch = !clientFilter || (transaction.client_id && transaction.client_id.toString().includes(clientFilter));
                const typeMatch = !typeFilter || transaction.transtype === typeFilter;
                const amountMatch = (transaction.amount || 0) >= amountMin && (transaction.amount || 0) <= amountMax;
                
                return clientMatch && typeMatch && amountMatch;
            });
            
            currentPage = 1;
            updateSummary();
            displayTransactions();
        }

        function clearFilters() {
            document.getElementById('client-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('amount-min').value = '';
            document.getElementById('amount-max').value = '';
            
            filteredTransactions = [...allTransactions];
            currentPage = 1;
            updateSummary();
            displayTransactions();
        }

        function viewTransaction(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (transaction) {
                alert(`Transaction Details:\n\nClient ID: ${transaction.client_id}\nInvoice: ${transaction.invoice_number}\nAmount: $${transaction.amount}\nType: ${transaction.transtype}\nDate: ${transaction.payment_date}\nComment: ${transaction.comment}`);
            }
        }

        function showUploadModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
        }

        function uploadNewFile() {
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an Excel file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const uploadBtn = document.querySelector('#uploadModal .btn-secondary');
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'Uploading...';
            uploadBtn.disabled = true;
            
            fetch(`/api/cashbook-upload/${jobId}/${subsidiaryId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    alert(`Successfully uploaded ${data.transactions_added} transactions!`);
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    loadCashbookTransactions(); // Reload data
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Error uploading file');
            })
            .finally(() => {
                uploadBtn.textContent = originalText;
                uploadBtn.disabled = false;
                fileInput.value = '';
            });
        }

        function deleteCashbookData() {
            if (confirm('Are you sure you want to delete all Cashbook data for this subsidiary? This action cannot be undone.')) {
                fetch(`/api/cashbook-transactions/${jobId}/${subsidiaryId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        alert(`Successfully deleted ${data.deleted_count} Cashbook transactions!`);
                        loadCashbookTransactions(); // Reload data
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    alert('Error deleting Cashbook data');
                });
            }
        }

        function exportData() {
            // Convert filtered transactions to CSV
            const csvContent = [
                'Payment Date,Client ID,Invoice Number,Billing Entity,Amount,Currency,Type,Location,Comment',
                ...filteredTransactions.map(t => 
                    `"${t.payment_date || ''}","${t.client_id || ''}","${t.invoice_number || ''}","${t.billing_entity || ''}",${t.amount || 0},"${t.currency || ''}","${t.transtype || ''}","${t.location || ''}","${t.comment || ''}"`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cashbook_transactions_${subsidiaryId}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function goBackToSubsidiary() {
            window.location.href = `/reconciliation/${jobId}/${subsidiaryId}`;
        }
    </script>
</body>
</html>
